title: Generating Standard GNU Distribution files under modern Git
author: Mohamad mehdi Kharatizadeh
date: 2018-07-12 16:55:21
tags:
---
Often programmers working with autotools are confused about legacy autotools files like `ChangeLog`, `NEWS`, etc. which are legacy to autotools ecosystem but are covered by `git`. Nonethless distribution tar balls generated by `make dist` target does not contain `.git` folder and are not expected to do so, thus they do not contain project change logs as necessary. In this article I will propose a way to generate these legacy files right from `git` and make it available to distribution tarballs.

## A little bit of history...

First let's on the grounding and talk about `autotools`. `autotools` is simple a unified set of tools that ease generation of `Makefile`s. It's widely used for opensource C/C++ projects on unix based systems, including Linux, BSD and OSX. 

`autotools` is part of GNU projects and has some strict standards for layout of projects. Some of these standards are as follows:

1. `./AUTHORS` file containing list of project maintainers. It is obvious that list of project maintainers and contributors can be easily read off git.
2. `./COPYING` file containing project license. This file is called `./LICENSE` nowadays.
3. `./ChangeLog` file containing detail modification history to project, including dates, authors, list of changed files, and an accompanying message to each change. The contents of this file, also obviously can be read from `git` history logs.
4. `./README` a text file containing project readme. For most of the projects nowadays, this file is replaced by a markdownfile called `README.md`.
5. `NEWS` file containing big highlights about project changes, like releases etc.

Now GNU has some standards on `Makefile`s as well, including which targets they should contain. Some of these important targets are as follows:

1. `make`: Default target of `Makefile`s should build project appropriately
2. `make install`: Install output of project to appropriate `bin`, `lib`, `include`, etc. folders.
3. `make check`: Run tests designed for checking integrity of package. They could be unit tests, functional tests, or sanity tests.
3. `make dist`: Create a `<project>-<version>.tar.gz` file containing all source files and generated files convenient for a `./configure && make && make install` directive on target systems. This tarball is important, as most of projects using `autoreconf` tool don't have a `./configure` script which is later generated by running `autoreconf -i` command. So the maintainer of project has to do this job, and create a ready-to-be-built tarball beforehand.

## The Problem

The problem with GNU project layout is that it's simply old. `git` does the work nowadays and contains list of authors, project releases as tags and also change logs. However the old rules are still enforced by `autotools`.

## The solution

The obvious solution with comes to mind is to disable enforcement of this standard project layout. This is done in `autoreconf` by providing **`foreign`** option to **`AM_INIT_AUTOMAKE`** macro. As an example, consider following listing of `configure.ac`:

```bash
AC_PREREQ([2.69])
AC_INIT([myproject], [0.1.0], [https://github.com/user/project/issues])

AC_CONFIG_AUX_DIR([build-aux])
AC_CONFIG_MACRO_DIR([m4])

AM_INIT_AUTOMAKE([1.14 -Wall -Werror foreign subdir-objects])
```

## Is it enough?

But this solution makes our distribution tarballs a little bit uneasy. Why? Because distribution tarballs do not contain `.git` subdirectory and are not expected to do so. Hence, they do not contain standard project layout and not even a clue about them.

## Proposal: Generate them off the git!

My solution to the problem is to generate standard GNU project layout from git. Now most projects using `autotools` typically have a `autogen.sh` or `bootstrap.sh` shell script which simple call `autoreconf -i` to generate `./configure` script from `configure.ac` file. My solution is to extend this `autogen.sh` to generate standard project layout from `git` history before calling `autoreconf`.

Like so:

```bash
#!/usr/bin/env bash

DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

cd $DIR && git shortlog -e -s -n > AUTHORS
cd $DIR && git tag -l -n1000 > NEWS
cd $DIR && cp README.md README
cd $DIR && cp LICENSE COPYING

echo "" > $DIR/ChangeLog
for hash in `cd $DIR && git log --pretty=format:"%H"`; do
    echo `cd $DIR && git log -1 --date=short --pretty=format:"%ad%x09%an%x09<%ae>" $hash` >> $DIR/ChangeLog
    echo "" >> $DIR/ChangeLog
    for file in `cd $DIR && git show --pretty="" --name-only $hash`; do
        echo -e '\t' $file: `cd $DIR && git log -1 --pretty=format:"%s" $hash` >> $DIR/ChangeLog
    done
    echo "" >> $DIR/ChangeLog
done

autoreconf --verbose --install
```

The above expansion to `autogen.sh` generates `./AUTHORS`, `./NEWS` and `ChangeLog` files from `git` history, moreover copies `./README` and `./COPYING` files from more modern `./README.md` and `./LICENSE` files before calling `autoreconf` so they could be safely integrated into distribution tarballs.

## Comments?

I would appreciate comments, if any, as if this way of thinking towards distribution tarballs is good or not, as well as my method of generating standard GNU compliant distribution tarballs. Please let me know!

